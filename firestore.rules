rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== HELPER FUNCTIONS =====

    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }

    function isValidName(name) {
      return name is string
        && name.size() >= 2
        && name.size() <= 100;
    }

    function isValidPhone(phone) {
      return phone is string && phone.size() >= 10;
    }

    // ===== REGISTRATIONS COLLECTION =====

    match /registrations/{document} {
      // Anyone can create (for public form submissions)
      allow create: if
        request.resource.data.firstName is string &&
        request.resource.data.lastName is string &&
        request.resource.data.phone is string &&
        request.resource.data.pastorName is string &&
        isValidName(request.resource.data.firstName) &&
        isValidName(request.resource.data.lastName) &&
        isValidPhone(request.resource.data.phone) &&
        // Email is optional but must be valid if provided
        (!('email' in request.resource.data) ||
          request.resource.data.email == null ||
          isValidEmail(request.resource.data.email)) &&
        // Ensure createdAt is set
        request.resource.data.createdAt == request.time &&
        // Status must be pending for new submissions
        request.resource.data.status == 'pending';

      // Only authenticated users (admins) can read, update, or delete
      allow read, update, delete: if request.auth != null;
    }

    // ===== VOLUNTEERS COLLECTION =====

    match /volunteers/{document} {
      allow create: if
        request.resource.data.firstName is string &&
        request.resource.data.lastName is string &&
        request.resource.data.phone is string &&
        isValidName(request.resource.data.firstName) &&
        isValidName(request.resource.data.lastName) &&
        isValidPhone(request.resource.data.phone) &&
        (!('email' in request.resource.data) ||
          request.resource.data.email == null ||
          isValidEmail(request.resource.data.email)) &&
        request.resource.data.createdAt == request.time &&
        request.resource.data.status == 'pending';

      allow read, update, delete: if request.auth != null;
    }

    // ===== VENDORS COLLECTION =====

    match /vendors/{document} {
      allow create: if
        request.resource.data.businessName is string &&
        request.resource.data.firstName is string &&
        request.resource.data.lastName is string &&
        request.resource.data.phone is string &&
        isValidName(request.resource.data.firstName) &&
        isValidName(request.resource.data.lastName) &&
        isValidPhone(request.resource.data.phone) &&
        (!('email' in request.resource.data) ||
          request.resource.data.email == null ||
          isValidEmail(request.resource.data.email)) &&
        request.resource.data.createdAt == request.time &&
        request.resource.data.status == 'pending' &&
        request.resource.data.approved == false;

      allow read, update, delete: if request.auth != null;
    }

    // ===== CONTACTS COLLECTION =====

    match /contacts/{document} {
      allow create: if
        request.resource.data.name is string &&
        isValidName(request.resource.data.name) &&
        request.resource.data.phone is string &&
        isValidPhone(request.resource.data.phone) &&
        request.resource.data.message is string &&
        request.resource.data.message.size() >= 1 &&
        // Email is optional but must be valid if provided
        (!('email' in request.resource.data) ||
          request.resource.data.email == null ||
          request.resource.data.email == '' ||
          isValidEmail(request.resource.data.email)) &&
        request.resource.data.createdAt == request.time &&
        request.resource.data.status == 'pending';

      allow read, update, delete: if request.auth != null;
    }

    // ===== RATE LIMITS COLLECTION =====
    // Used for server-side rate limiting tracking

    match /rateLimits/{document} {
      // Only Cloud Functions can write to this collection
      allow read, write: if false;
    }
  }
}
